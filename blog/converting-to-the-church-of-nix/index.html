<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><script async defer data-domain=jdheyburn.co.uk src=https://stats.jdheyburn.co.uk/js/index.js></script><meta name=author content="Joseph D. Heyburn"><meta name=description content="Ramblings of a tech guy"><meta name=keywords content="blog,developer,devops,cloud"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://jdheyburn.co.uk/blog/converting-to-the-church-of-nix/cover.png"><meta name=twitter:title content="Converting to the Church of Nix"><meta name=twitter:description content="Migrating self-hosted services to NixOS, in this quick introductory post"><meta property="og:title" content="Converting to the Church of Nix"><meta property="og:description" content="Migrating self-hosted services to NixOS, in this quick introductory post"><meta property="og:type" content="article"><meta property="og:url" content="https://jdheyburn.co.uk/blog/converting-to-the-church-of-nix/"><meta property="og:image" content="https://jdheyburn.co.uk/blog/converting-to-the-church-of-nix/cover.png"><meta property="article:published_time" content="2022-10-17T00:00:00+00:00"><meta property="article:modified_time" content="2022-10-17T00:00:00+00:00"><base href=https://jdheyburn.co.uk/blog/converting-to-the-church-of-nix/><title>Converting to the Church of Nix · JDHeyburn</title><link rel=canonical href=https://jdheyburn.co.uk/blog/converting-to-the-church-of-nix/><link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel=stylesheet><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.13.0/css/all.css integrity=sha384-Bfad6CLCknfcloXFOyFnlgtENryhrpZCe29RTifKEixXQZ38WheV+i/6YWSzkz3V crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin=anonymous><link rel=stylesheet href=https://jdheyburn.co.uk/css/coder.min.f01c647a0d25b40da992a37c3376291185eed8a50ced8c26cc2c0bcfe38c97df.css integrity="sha256-8Bxkeg0ltA2pkqN8M3YpEYXu2KUM7YwmzCwLz+OMl98=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://jdheyburn.co.uk/css/coder-dark.min.126ad3988d46bdae6217a11105b53c9662bca05f39d42d3c0fb366919d334620.css integrity="sha256-EmrTmI1Gva5iF6ERBbU8lmK8oF851C08D7NmkZ0zRiA=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://jdheyburn.co.uk/css/custom.css><link rel=icon type=image/png href=https://jdheyburn.co.uk/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://jdheyburn.co.uk/images/favicon-16x16.png sizes=16x16><meta name=generator content="Hugo 0.104.3"></head><body class=colorscheme-dark><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://jdheyburn.co.uk/>JDHeyburn</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://jdheyburn.co.uk/about/>About</a></li><li class=navigation-item><a class=navigation-link href=https://jdheyburn.co.uk/blog/>Blog</a></li><li class=navigation-item><a class=navigation-link href=https://jdheyburn.co.uk/projects/>Projects</a></li><li class=navigation-item><a class=navigation-link href=https://jdheyburn.co.uk/contact/>Contact</a></li></ul></section></nav><div class=content><section class="container post"><article><div><img class=featimage src=https://jdheyburn.co.uk/blog/converting-to-the-church-of-nix/cover.png alt="Featured image"></div><header><div class=post-title><h1 class=title>Converting to the Church of Nix</h1></div><div class=post-description><p>Migrating self-hosted services to NixOS, in this quick introductory post</p></div><div class=post-meta><div class=date><span class=posted-on><i class="fas fa-calendar"></i>
<time datetime=2022-10-17T00:00:00Z>17 October 2022</time></span>
<span class=reading-time><i class="fas fa-clock"></i>
7-minute read</span></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<a href=https://jdheyburn.co.uk/tags/homelab/>homelab</a>
<span class=separator>•</span>
<a href=https://jdheyburn.co.uk/tags/nix/>nix</a></div></div></header><div><aside><nav id=TableOfContents><ul><li><a href=#why-nixos>Why NixOS</a></li><li><a href=#layout>Layout</a><ul><li><a href=#legacy>Legacy</a></li><li><a href=#today>Today</a></li></ul></li><li><a href=#additional-features>Additional features</a></li><li><a href=#configurations>Configurations</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></aside><p>I&rsquo;ve <a href=https://jdheyburn.co.uk/blog/reverse-proxy-multiple-domains-using-caddy-2/>written in the past</a> about some services I host at home which were running on a Raspberry Pi 3 with Raspbian. Making changes to the host was done ad-hoc with no configuration management tool like Ansible, so should anything happen to the host and it dies, I won&rsquo;t have a way to reproduce what I had working before.</p><p>Naturally last December, the Pi SD card got corrupted and lost everything that was on there.</p><p>Rather than rebuilding things how they were in the same way as before, I wanted to look into a better way to ensure I could reproduce services installed and manage configurations on a host to mitigate this in the future.</p><p>NixOS came to mind as it solves these problems and more, I had tried to get it working on the Pi and on my Dell XPS 9360 laptop in the past with unsuccessful results. This time round there is much greater support for NixOS on Pi, and coupled with some more motivation, I decided to make the switch.</p><p>In this series I&rsquo;ll be writing about my setup, how I deploy modules, onboarding flakes, and problems I came across along the way. The series will be more NixOS config management orientated, while being referred back to in other posts where I&rsquo;ll talk about some of the services I&rsquo;m running via NixOS. This post kicks off with a quick introduction with some more in-depth posts to come.</p><h2 id=why-nixos>Why NixOS</h2><p>For a quick 411, there are 3 components that fall under the &ldquo;Nix&rdquo; umbrella:</p><ul><li>Nix / Nixlang<ul><li>The functional, declarative language that is used to build, manipulate, packages, files, configurations, within the ecosystem</li></ul></li><li>Nixpkgs<ul><li>A package manager that can be installed on a Linux machine, or on macOS via <a href=https://github.com/LnL7/nix-darwin>nix-darwin</a></li><li>Think an alternative to <code>apt</code>, <code>brew</code>, etc.</li></ul></li><li>NixOS<ul><li>An operating system that uses Nixpkgs as its package manager, but also can configure OS-level configurations, hardware settings, services, via Nixlang</li></ul></li></ul><p>Nixpkgs are designed to be easily reproducible by defining explicit versions and hashes of software and its dependencies - and the same goes for NixOS which takes this same philisophy and applies it beyond software. Nix builds this software and stores it in the Nix store (appropriately named <code>/nix/store</code>), where a previous deployment of a configuration can be rolled back easily with a single command. This makes it useful for experiments or to rollback when shit hits the fan.</p><p>There are plenty of talented people who have written about it before, so I&rsquo;ll link them here:</p><ul><li><a href=https://nixos.org/manual/nix/stable/introduction.html>NixOS manual introduction</a></li><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/introduction/>How to Learn Nix, Part 1: What&rsquo;s all this about?</a></li></ul><p>So the 3 components together allow for some pretty powerful stuff. Your NixOS configurations are written to a <code>.nix</code> suffixed file by default located at <code>/etc/nixos/configuration.nix</code>, which can contain minimal config:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{ config<span style=color:#ff79c6>,</span> pkgs<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>...</span> }:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  networking<span style=color:#ff79c6>.</span>hostName <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;my-hostname&#34;</span>; <span style=color:#6272a4># Define your hostname.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4># Set your time zone.</span>
</span></span><span style=display:flex><span>  time<span style=color:#ff79c6>.</span>timeZone <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;Europe/London&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4># Define a user account. Don&#39;t forget to set a password with ‘passwd’.</span>
</span></span><span style=display:flex><span>  users<span style=color:#ff79c6>.</span>users<span style=color:#ff79c6>.</span>my-user <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>    isNormalUser <span style=color:#ff79c6>=</span> true;
</span></span><span style=display:flex><span>    home <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;/home/my-user&#34;</span>;
</span></span><span style=display:flex><span>    extraGroups <span style=color:#ff79c6>=</span> [ <span style=color:#f1fa8c>&#34;wheel&#34;</span> <span style=color:#f1fa8c>&#34;networkmanager&#34;</span> ]; <span style=color:#6272a4># Enable ‘sudo’ for the user.</span>
</span></span><span style=display:flex><span>    password <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;hunter2&#34;</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  environment<span style=color:#ff79c6>.</span>systemPackages <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>with</span> pkgs; [
</span></span><span style=display:flex><span>    vim
</span></span><span style=display:flex><span>  ];
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Whenever we want to deploy the configuration to make it live, we can use the command <code>nixos-rebuild switch</code>, which will read this file and build the packages and configurations requested.</p><p>Should we want to have Firefox installed? We can just define it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>environment<span style=color:#ff79c6>.</span>systemPackages = <span style=color:#ff79c6>with</span> pkgs; [
</span></span><span style=display:flex><span>  vim
</span></span><span style=display:flex><span>  <span style=color:#6272a4># add in the below</span>
</span></span><span style=display:flex><span>  firefox
</span></span><span style=display:flex><span>];
</span></span></code></pre></div><p>If we want to enable SSH access to our hosts, it&rsquo;s easy to do that:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>  <span style=color:#6272a4># Enable the OpenSSH daemon.</span>
</span></span><span style=display:flex><span>  services<span style=color:#ff79c6>.</span>openssh = {
</span></span><span style=display:flex><span>    enable <span style=color:#ff79c6>=</span> true;
</span></span><span style=display:flex><span>    permitRootLogin <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;no&#34;</span>;
</span></span><span style=display:flex><span>    passwordAuthentication <span style=color:#ff79c6>=</span> true;
</span></span><span style=display:flex><span>  };
</span></span></code></pre></div><p>Services are usually defined with the syntax <code>services.SERVICE_NAME.enable</code>, however as shown above we can see <code>permitRootLogin</code> and <code>passwordAuthentication</code> attributes are defined. These inputs are read by the <a href=https://github.com/NixOS/nixpkgs/blob/nixos-unstable/nixos/modules/services/networking/ssh/sshd.nix#L148>service in nixpkgs</a> to then be <a href=https://github.com/NixOS/nixpkgs/blob/nixos-unstable/nixos/modules/services/networking/ssh/sshd.nix#L533>output as configuration</a> for the service.</p><p>One last example, what if the service we just deployed requires a particular port opened? NixOS can do that too!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>networking<span style=color:#ff79c6>.</span>firewall<span style=color:#ff79c6>.</span>allowedTCPPorts = [ <span style=color:#bd93f9>4040</span> ];
</span></span></code></pre></div><p>When you compare that against traditional package managers, you would first have to install the software <em>and then</em> configure it, probably by hand. On top of that, you would have to manage the versioning of the configuration using another tool. <strong>NixOS does all of that for you</strong> - provided that you&rsquo;re checking in your NixOS configuration files!</p><p>Just to cap off - if something broke during the <code>nixos-rebuild switch</code> command and you want to go back to the previous state, then we can do so with <code>nixos-rebuild switch --rollback</code>.</p><h2 id=layout>Layout</h2><p>Before going into the details of the setup I&rsquo;m running I think it helps to have some context of where I was before the migration.</p><h3 id=legacy>Legacy</h3><p>Prior to starting this, I had this setup across my network:</p><h4 id=dee>dee</h4><p>My starting point for playing with self-hosting, it was a Raspberry Pi 3.</p><table><thead><tr><th>Service</th><th>Purpose</th></tr></thead><tbody><tr><td><a href=https://caddyserver.com/>Caddy</a></td><td>Reverse proxy for all services in the network</td></tr><tr><td>NFS server</td><td>Network wide storage, backed up to cloud storage</td></tr><tr><td><a href=https://pi-hole.net/>PiHole</a></td><td>For adblocking and local DNS resolution</td></tr><tr><td>UniFi Controller</td><td>Control plane for my UniFi devices at home</td></tr></tbody></table><h4 id=frank>frank</h4><p>A Ubuntu VM on a Proxmox hypervisor, built so that I could play with Proxmox and docker containers.</p><table><thead><tr><th>Service</th><th>Purpose</th></tr></thead><tbody><tr><td><a href=https://heimdall.site/>Heimdall</a></td><td>Dashboard for services</td></tr><tr><td><a href=https://github.com/huginn/huginn>Huginn</a></td><td>Experiment with automation (such as <a href=https://jdheyburn.co.uk/blog/alerting-on-nhs-coronavirus-vaccine-updates-with-huginn/>NHS vaccine alerts</a>)</td></tr><tr><td><a href=https://www.portainer.io/>Portainer</a></td><td>UI for docker containers</td></tr></tbody></table><h3 id=today>Today</h3><p>Host frank is unchanged from above today, while here&rsquo;s what I have running elsewhere.</p><h4 id=dee-1>dee</h4><p>Upgraded to a Raspberry Pi 4 (NixOS is RAM hungry!) in an <a href=https://thepihut.com/products/argon-one-m-2-raspberry-pi-4-case>Argon One case</a>.</p><table><thead><tr><th>Service</th><th>Purpose</th></tr></thead><tbody><tr><td><a href=https://github.com/AdguardTeam/AdGuardHome>AdGuardHome</a></td><td>For adblocking and local DNS resolution (replaces PiHole)</td></tr><tr><td><a href=https://caddyserver.com/>Caddy</a></td><td>Reverse proxy for services <em>local to the host</em></td></tr><tr><td><a href=https://healthchecks.io/>Healthchecks</a></td><td>Monitor cron jobs (primarily the backup jobs for now)</td></tr><tr><td><a href=https://min.io/>Minio</a></td><td>S3 compatible storage</td></tr><tr><td>NFS server</td><td>Network wide storage, backed up to cloud storage</td></tr><tr><td><a href=https://www.plex.tv/>Plex</a></td><td>Music and video player</td></tr><tr><td>UniFi Controller</td><td>Control plane for UniFi devices</td></tr></tbody></table><h4 id=dennis>dennis</h4><p>New VM running NixOS on the Proxmox HV. I built this as I had some RAM issues on dee, which I subsequently fixed but ended up putting more services on there to experiment with multiple hosts.</p><table><thead><tr><th>Service</th><th>Purpose</th></tr></thead><tbody><tr><td><a href=https://caddyserver.com/>Caddy</a></td><td>Reverse proxy for services <em>local to the host</em></td></tr><tr><td><a href=https://dashy.to/>Dashy</a></td><td>Replaces Heimdall as a dashboard for services</td></tr><tr><td><a href=https://grafana.com/>Grafana</a></td><td>Metric and log visualisation</td></tr><tr><td><a href=https://grafana.com/oss/loki/>Loki</a></td><td>Log collections</td></tr><tr><td><a href=https://prometheus.io/>Prometheus</a> with <a href=https://thanos.io/>Thanos</a></td><td>Metric scraping and long term storage</td></tr><tr><td><a href=https://victoriametrics.com/>Victoria Metrics</a></td><td>Metric scraping (just testing as a potential Prometheus replacement)</td></tr></tbody></table><h2 id=additional-features>Additional features</h2><p>Besides NixOS itself, there are some extra features which I&rsquo;m using in the stack:</p><ul><li><a href=https://xeiaso.net/blog/nix-flakes-1-2022-02-21>nix flakes</a><ul><li>Version pin dependencies</li><li>Allows for an additional layer of reproducibility</li></ul></li><li><a href=https://github.com/ryantm/agenix>agenix</a><ul><li>Encryption using <a href=https://github.com/FiloSottile/age>age</a></li><li>Allows for secrets to be safely checked in to Git repos so that they can be used in configurations</li></ul></li><li><a href=https://github.com/serokell/deploy-rs>deploy-rs</a><ul><li>Deploy NixOS configurations to hosts remotely</li></ul></li><li><a href=https://github.com/nix-community/home-manager>home-manager</a><ul><li>Allows configuration of user-level programs and settings</li><li>Typically used as a <a href=https://www.freecodecamp.org/news/dotfiles-what-is-a-dot-file-and-how-to-create-it-in-mac-and-linux/>dotfile</a> manager, which can replace tools such as <a href=https://www.chezmoi.io/>chezmoi</a></li><li>Can be applied to non-NixOS machines</li></ul></li><li><a href=https://github.com/NixOS/nixos-hardware>nixos-hardware</a><ul><li>Crowdsourced configuration best practices to get NixOS running smoothly on particular hardware</li></ul></li></ul><h2 id=configurations>Configurations</h2><p>Since NixOS can be used to build packages and services, it can also be used to build configurations. I have defined a service &ldquo;catalog&rdquo; which acts as a source of truth for services, so that dependent services can refer back to this to build their own config. Some examples of this are generating configs used for:</p><ul><li>DNS rewrites to forward DNS names to the host hosting the service</li><li>Reverse proxy the service to the port</li><li>Dashy for the home dashboard</li><li>Prometheus monitoring service endpoints</li></ul><p>The inspiration for having a centralised location for service catalog came from jhillyerd - where they <a href=https://github.com/jhillyerd/homelab/blob/main/nixos/catalog.nix>achieve the same thing</a>.</p><p>My NixOS configurations are stored in <a href=https://github.com/jdheyburn/nixos-configs>GitHub</a>, so you can have a browse through there. Subsequent posts will dive into what each of these is doing in more detail, but here&rsquo;s a high-level of the top-level directories.</p><p><code>common/</code></p><ul><li>Settings that are applied to all hosts</li></ul><p><code>home-manager/</code></p><ul><li>User-level programs and settings</li></ul><p><code>hosts/</code></p><ul><li>Configurations for individual hosts, along with their hardware configs via <a href=https://github.com/NixOS/nixos-hardware>nixos-hardware</a></li></ul><p><code>modules/</code></p><ul><li>Where services and their dependencies are defined</li><li>Rarely do I install software via just <code>services.SERVICE_NAME.enable = true</code>, there is usually extra properties to come with it - so having wrapping them in a custom module is usually easiest for me to maintain</li></ul><p><code>overlays/</code></p><ul><li>Nix overlays allow you to overwrite packages and configurations pulled from a dependency</li><li>In my case here, I&rsquo;m using it to fix some bugs in one program, and add functionality to another</li></ul><p><code>secrets/</code></p><ul><li>Where agenix secrets are stored</li></ul><p><code>catalog.nix</code></p><ul><li>Contains information about the various services and where</li></ul><p><code>flake.nix</code></p><ul><li>The main entry point into the configurations when deploying</li></ul><h2 id=conclusion>Conclusion</h2><p>This is only a quick introduction into the series which introduces NixOS, what I&rsquo;m using it for, and a high-level look into the configurations.</p></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2023
Joseph D. Heyburn
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main></body></html>