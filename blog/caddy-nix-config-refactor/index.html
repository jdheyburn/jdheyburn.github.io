<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><script defer data-domain=jdheyburn.co.uk data-api=/other/apples/event src=https://jdheyburn.co.uk/other/apples/script.js></script><meta name=author content="Joseph D. Heyburn"><meta name=description content="Ramblings of a tech guy"><meta name=keywords content="blog,developer,devops,cloud"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://jdheyburn.co.uk/images/jdheyburn_co_uk_card.png"><meta name=twitter:title content="Simplifying Caddy configs in NixOS"><meta name=twitter:description content="I refactor my Caddy configs from the unnecessarily complex method to something a whole lot more simpler"><meta property="og:title" content="Simplifying Caddy configs in NixOS"><meta property="og:description" content="I refactor my Caddy configs from the unnecessarily complex method to something a whole lot more simpler"><meta property="og:type" content="article"><meta property="og:url" content="https://jdheyburn.co.uk/blog/caddy-nix-config-refactor/"><meta property="og:image" content="https://jdheyburn.co.uk/images/jdheyburn_co_uk_card.png"><meta property="article:published_time" content="2024-03-07T00:00:00+00:00"><meta property="article:modified_time" content="2024-03-07T00:00:00+00:00"><base href=https://jdheyburn.co.uk/blog/caddy-nix-config-refactor/><title>Simplifying Caddy configs in NixOS ¬∑ JDHeyburn</title><link rel=canonical href=https://jdheyburn.co.uk/blog/caddy-nix-config-refactor/><link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel=stylesheet><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.13.0/css/all.css integrity=sha384-Bfad6CLCknfcloXFOyFnlgtENryhrpZCe29RTifKEixXQZ38WheV+i/6YWSzkz3V crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin=anonymous><link rel=stylesheet href=https://jdheyburn.co.uk/css/coder.min.f01c647a0d25b40da992a37c3376291185eed8a50ced8c26cc2c0bcfe38c97df.css integrity="sha256-8Bxkeg0ltA2pkqN8M3YpEYXu2KUM7YwmzCwLz+OMl98=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://jdheyburn.co.uk/css/coder-dark.min.126ad3988d46bdae6217a11105b53c9662bca05f39d42d3c0fb366919d334620.css integrity="sha256-EmrTmI1Gva5iF6ERBbU8lmK8oF851C08D7NmkZ0zRiA=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://jdheyburn.co.uk/css/custom.css><link rel=icon type=image/png href=https://jdheyburn.co.uk/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://jdheyburn.co.uk/images/favicon-16x16.png sizes=16x16><meta name=generator content="Hugo 0.104.3"></head><body class=colorscheme-dark><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://jdheyburn.co.uk/>JDHeyburn</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://jdheyburn.co.uk/about/>About</a></li><li class=navigation-item><a class=navigation-link href=https://jdheyburn.co.uk/blog/>Blog</a></li><li class=navigation-item><a class=navigation-link href=https://jdheyburn.co.uk/projects/>Projects</a></li><li class=navigation-item><a class=navigation-link href=https://jdheyburn.co.uk/contact/>Contact</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title>Simplifying Caddy configs in NixOS</h1></div><div class=post-description><p>I refactor my Caddy configs from the unnecessarily complex method to something a whole lot more simpler</p></div><div class=post-meta><div class=date><span class=posted-on><i class="fas fa-calendar"></i>
<time datetime=2024-03-07T00:00:00Z>7 March 2024</time></span>
<span class=reading-time><i class="fas fa-clock"></i>
3-minute read</span></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<a href=https://jdheyburn.co.uk/tags/caddy/>caddy</a>
<span class=separator>‚Ä¢</span>
<a href=https://jdheyburn.co.uk/tags/nixos/>nixos</a></div></div></header><div><aside><nav id=TableOfContents><ul><li><a href=#tldr>tl;dr</a></li><li><a href=#a-gentle-reminder>A gentle reminder</a></li><li><a href=#i-have-seen-the-light>I have seen the light</a></li></ul></nav></aside><h2 id=tldr>tl;dr</h2><ul><li>My Caddy configs before were <a href=https://jdheyburn.co.uk/blog/automating-service-configurations-with-nixos/#caddy-config>bloody awfully</a> complicated</li><li>I scrapped that way of doing it and made it simpler in <a href=https://github.com/jdheyburn/nixos-configs/pull/66>this pull request</a></li></ul><h2 id=a-gentle-reminder>A gentle reminder</h2><p>I&rsquo;ve written before about how I use Caddy to <a href=https://jdheyburn.co.uk/blog/reverse-proxy-multiple-domains-using-caddy-2/>reverse proxy</a> my internal services. Since then I&rsquo;ve migrated to NixOS and am using that to <a href=https://jdheyburn.co.uk/blog/automating-service-configurations-with-nixos/#caddy-config>automatically generate</a> the Caddy config.</p><p>However the approach I used was extremely over-engineered and unnecessarily complicates one of the benefits of Caddy, which is the simplicity of its <a href=https://caddyserver.com/docs/caddyfile>Caddyfile DSL</a>. It was interesting to see how I could generate configs from Nix attribute sets, which served as a learning exercise and the basis for the <a href=blog/nix-cheat-sheet/>Nix cheat sheet</a>.</p><p>NixOS allows you to <a href=https://github.com/NixOS/nixpkgs/blob/abde03c6b3d19be0a69c57e5a1f475b03a09dd71/nixos/modules/services/web-servers/caddy/default.nix#L11-L48>specify Caddy config</a> in a way that allows you to modularise it. Migrating to this structure will provide cleaner code for future iterations.</p><p>Previously I had created the <a href=https://github.com/jdheyburn/nixos-configs/blob/5175593745a27de7afc5249bc130a2f1c5edb64c/modules/caddy/default.nix>module for Caddy</a> in such a way that it would discover what services required a reverse proxy fronting it on said host. This snippet from the previous config would look up from the catalog for any services that were due to be hosted on this machine, then build the Caddy config from there.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>host_services = attrValues (filterAttrs (svc_name: svc_def:
</span></span><span style=display:flex><span>  svc_def <span style=color:#ff79c6>?</span> <span style=color:#f1fa8c>&#34;host&#34;</span> <span style=color:#ff79c6>&amp;&amp;</span> svc_def<span style=color:#ff79c6>.</span>host<span style=color:#ff79c6>.</span>hostName <span style=color:#ff79c6>==</span> config<span style=color:#ff79c6>.</span>networking<span style=color:#ff79c6>.</span>hostName
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>&amp;&amp;</span> svc_def<span style=color:#ff79c6>.</span>caddify<span style=color:#ff79c6>.</span>enable) catalog<span style=color:#ff79c6>.</span>services);
</span></span></code></pre></div><h2 id=i-have-seen-the-light>I have seen the light</h2><p>Instead of doing all the building of the Caddy JSON config by hand, I can declare a block in each service module <em>that requires it</em> which will ensure Caddy will create a reverse proxy for it. This means a module now encapsulates everything that is required for this service to function properly.</p><p>Such a module would then look like the below, with some lines removed for brevity. You can see it in full in <a href=https://github.com/jdheyburn/nixos-configs/blob/46eca0686b735ff74a19867c625e7ecca2d9034a/modules/plex/default.nix>GitHub</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{ config<span style=color:#ff79c6>,</span> pkgs<span style=color:#ff79c6>,</span> lib<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>...</span> }:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>with</span> lib;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>let</span> cfg <span style=color:#ff79c6>=</span> config<span style=color:#ff79c6>.</span>modules<span style=color:#ff79c6>.</span>plex;
</span></span><span style=display:flex><span><span style=color:#ff79c6>in</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  options<span style=color:#ff79c6>.</span>modules<span style=color:#ff79c6>.</span>plex <span style=color:#ff79c6>=</span> { enable <span style=color:#ff79c6>=</span> mkEnableOption <span style=color:#f1fa8c>&#34;Deploy plex&#34;</span>; };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  config <span style=color:#ff79c6>=</span> mkIf cfg<span style=color:#ff79c6>.</span>enable {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    services<span style=color:#ff79c6>.</span>caddy<span style=color:#ff79c6>.</span>virtualHosts<span style=color:#ff79c6>.</span><span style=color:#f1fa8c>&#34;plex.svc.joannet.casa&#34;</span><span style=color:#ff79c6>.</span>extraConfig <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      tls {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        dns cloudflare {env.CLOUDFLARE_API_TOKEN}
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      reverse_proxy localhost:32400
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    &#39;&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    services<span style=color:#ff79c6>.</span>plex <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>      enable <span style=color:#ff79c6>=</span> true;
</span></span><span style=display:flex><span>      openFirewall <span style=color:#ff79c6>=</span> true;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This is a lot simpler, and it meant that I was able to remove a <strong>lot</strong> of complicated Nix code in the <a href=https://github.com/jdheyburn/nixos-configs/pull/66>pull request</a> to achieve the same thing. The end result is a solution that is much easier to understand and pragmatic.</p><p>I&rsquo;m still using a <a href=https://github.com/jdheyburn/nixos-configs/blob/46eca0686b735ff74a19867c625e7ecca2d9034a/modules/dns/default.nix#L8-L31>similar method</a> for when writing the AdGuardHome DNS config, but I changed the functions to more appropriate names. You can <a href=https://jdheyburn.co.uk/blog/automating-service-configurations-with-nixos/#dns-rewrites>revisit the previous blog post</a> where I walk through that.</p><p>This refactoring to more complete modules isn&rsquo;t ground-breaking by any means, but I wanted to share this win I gained üëç.</p></div><footer></footer></article></section></div><footer class=footer><section class=container>¬©
2024
Joseph D. Heyburn
¬∑
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main></body></html>