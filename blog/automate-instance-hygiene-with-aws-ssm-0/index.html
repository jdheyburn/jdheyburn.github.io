<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><script async defer data-domain=jdheyburn.co.uk src=https://stats.jdheyburn.co.uk/js/index.js></script><meta name=author content="Joseph D. Heyburn"><meta name=description content="Ramblings of a tech guy"><meta name=keywords content="blog,developer,devops,cloud"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://jdheyburn.co.uk/blog/automate-instance-hygiene-with-aws-ssm-0/card.png"><meta name=twitter:title content="Automate Instance Hygiene with AWS SSM: Command Documents"><meta name=twitter:description content="Exploring how to execute scripts across multiple platforms with AWS SSM Command Documents"><meta property="og:title" content="Automate Instance Hygiene with AWS SSM: Command Documents"><meta property="og:description" content="Exploring how to execute scripts across multiple platforms with AWS SSM Command Documents"><meta property="og:type" content="article"><meta property="og:url" content="https://jdheyburn.co.uk/blog/automate-instance-hygiene-with-aws-ssm-0/"><meta property="og:image" content="https://jdheyburn.co.uk/blog/automate-instance-hygiene-with-aws-ssm-0/card.png"><meta property="article:published_time" content="2020-10-29T00:00:00+00:00"><meta property="article:modified_time" content="2020-10-30T00:00:00+00:00"><base href=https://jdheyburn.co.uk/blog/automate-instance-hygiene-with-aws-ssm-0/><title>Automate Instance Hygiene with AWS SSM: Command Documents Â· JDHeyburn</title><link rel=canonical href=https://jdheyburn.co.uk/blog/automate-instance-hygiene-with-aws-ssm-0/><link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel=stylesheet><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.13.0/css/all.css integrity=sha384-Bfad6CLCknfcloXFOyFnlgtENryhrpZCe29RTifKEixXQZ38WheV+i/6YWSzkz3V crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin=anonymous><link rel=stylesheet href=https://jdheyburn.co.uk/css/coder.min.a4f332213a21ce8eb521670c614470c58923aaaf385e2a73982c31dd7642decb.css integrity="sha256-pPMyITohzo61IWcMYURwxYkjqq84XipzmCwx3XZC3ss=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://jdheyburn.co.uk/css/coder-dark.min.83a2010dac9f59f943b3004cd6c4f230507ad036da635d3621401d42ec4e2835.css integrity="sha256-g6IBDayfWflDswBM1sTyMFB60DbaY102IUAdQuxOKDU=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://jdheyburn.co.uk/css/custom.css><link rel=icon type=image/png href=https://jdheyburn.co.uk/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://jdheyburn.co.uk/images/favicon-16x16.png sizes=16x16><meta name=generator content="Hugo 0.69.0"></head><body class=colorscheme-dark><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://jdheyburn.co.uk/>JDHeyburn</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fas fa-bars"></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://jdheyburn.co.uk/about/>About</a></li><li class=navigation-item><a class=navigation-link href=https://jdheyburn.co.uk/blog/>Blog</a></li><li class=navigation-item><a class=navigation-link href=https://jdheyburn.co.uk/projects/>Projects</a></li><li class=navigation-item><a class=navigation-link href=https://jdheyburn.co.uk/contact/>Contact</a></li></ul></section></nav><div class=content><section class="container post"><article><div><img class=featimage src=https://jdheyburn.co.uk/blog/automate-instance-hygiene-with-aws-ssm-0/cover.png alt="Featured image"></div><header><div class=post-title><h1 class=title>Automate Instance Hygiene with AWS SSM: Command Documents</h1></div><div class=post-description><p>Exploring how to execute scripts across multiple platforms with AWS SSM Command Documents</p></div><div class=post-meta><div class=date><span class=posted-on><i class="fas fa-calendar"></i><time datetime=2020-10-29T00:00:00Z>29 October 2020</time></span>
<span class=posted-on><i class="fas fa-calendar-plus"></i><time datetime=2020-10-30T00:00:00Z>30 October 2020</time></span>
<span class=reading-time><i class="fas fa-clock"></i>16-minute read</span></div><div class=tags><i class="fas fa-tag"></i><a href=https://jdheyburn.co.uk/tags/aws/>aws</a>
<span class=separator>â€¢</span>
<a href=https://jdheyburn.co.uk/tags/ssm/>ssm</a>
<span class=separator>â€¢</span>
<a href=https://jdheyburn.co.uk/tags/automation/>automation</a>
<span class=separator>â€¢</span>
<a href=https://jdheyburn.co.uk/tags/terraform/>terraform</a>
<span class=separator>â€¢</span>
<a href=https://jdheyburn.co.uk/tags/patching/>patching</a></div></div></header><div><aside><nav id=TableOfContents><ul><li><a href=#tldr>tl;dr</a></li><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#ssm-re-primer>SSM Re-primer</a><ul><li><a href=#ssm-managed-instances>SSM Managed Instances</a></li></ul></li><li><a href=#command-documents>Command documents</a><ul><li><a href=#constructing-a-healthcheck-script>Constructing a healthcheck script</a></li><li><a href=#testing-in-aws-ssm-console>Testing in AWS SSM Console</a></li><li><a href=#terraforming-command-documents>Terraforming command documents</a></li></ul></li><li><a href=#verbose-command-documents>Verbose command documents</a><ul><li><a href=#terraforming-verbose-command-documents>Terraforming verbose command documents</a></li><li><a href=#testing-verbose-documents>Testing verbose documents</a></li></ul></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></aside><p>It&rsquo;s been a while since my <a href=https://jdheyburn.co.uk/blog/assertions-in-gotests-test-generation/>last post</a>&mldr; which could be down to me trying to salvage something out of summer! ðŸ˜…</p><p>In this post I want to talk a little bit more about <a href=https://docs.aws.amazon.com/systems-manager/latest/userguide/what-is-systems-manager.html>AWS SSM</a>. This was something I touched on when discussing patch baselines in a <a href=https://jdheyburn.co.uk/blog/using-terraform-to-manage-aws-patch-baselines-at-enterprise-scale/#ssm--patch-manager>previous post</a>, and within there is another service known as <a href=https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-automation.html>Automation</a>. On first glance it may look pretty dull, but once you scratch the surface there are a number of capabilities it can unlock for you. I found a distinct lack of resources on how to write these documents, so this post will aim to help you get started on doing so!</p><p>This will be part one of a four part series about SSM Automation. The outline of the posts will be:</p><ol><li>Re-introduction to SSM Documents in general, specifically the Command document by writing our own healthcheck document</li><li>How to automate command documents with SSM Maintenance Windows</li><li>Looking into Automation documents, and integrating them with maintenance windows</li><li>Advanced use case for Automation documents</li></ol><h2 id=tldr>tl;dr</h2><p>To summarise the key parts of this post:</p><ul><li>SSM can be used to automate several parts of your estate</li><li>Command documents are a means of executing logically indifferent commands across multiple platforms</li><li>How to write a <a href=#terraforming-command-documents>basic command document</a> in Terraform</li><li>How to write a <a href=#terraforming-verbose-command-documents>verbose command document</a> in Terraform</li></ul><h2 id=prerequisites>Prerequisites</h2><p>This series assumes you have some knowledge of:</p><ul><li>Terraform</li><li>These AWS services:<ul><li>EC2</li><li>IAM</li><li>S3</li></ul></li></ul><p>All source code for this post is available on <a href=https://github.com/jdheyburn/terraform-examples/tree/main/aws-ssm-automation-0>GitHub</a>, I&rsquo;ll be referencing it throughout.</p><h2 id=ssm-re-primer>SSM Re-primer</h2><p>I&rsquo;ve mentioned <a href=https://jdheyburn.co.uk/blog/using-terraform-to-manage-aws-patch-baselines-at-enterprise-scale/#ssm--patch-manager>SSM Documents</a> before; to save you a click:</p><blockquote><p>An <a href=https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-ssm-docs.html>SSM Document</a> is essentially an automation script that you can perform on one or more instances at a time, with conditions to apply different sets of scripts depending on the operating system (OS) platform (i.e. Windows / Linux).</p></blockquote><p>In that post I talk about how <strong>AWS-RunPatchBaseline</strong> is an example of a <code>COMMAND</code> document. Another type of document is known as <code>AUTOMATION</code>. AWS <a href=https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-ssm-docs.html>describes them</a> as:</p><ul><li>Command<ul><li>Uses command documents to run commands</li><li>State Manager uses command documents to apply a configuration</li><li>These actions can be run on one or more targets at any point during the lifecycle of an instance</li><li>Maintenance Windows uses command documents to apply a configuration based on the specified schedule</li></ul></li><li>Automation<ul><li>Use automation documents when performing common maintenance and deployment tasks such as creating or updating an Amazon Machine Image (AMI)</li><li>State Manager uses automation documents to apply a configuration</li><li>These actions can be run on one or more targets at any point during the lifecycle of an instance</li><li>Maintenance Windows uses automation documents to perform common maintenance and deployment tasks based on the specified schedule</li></ul></li></ul><p>I like to use the below to differentiate between the two:</p><ul><li>Command documents execute scripts on instances</li><li>Automation document can call and orchestrate AWS API endpoints on your behalf, including executing Command documents on instances</li></ul><p>There are also <a href=https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-ssm-docs.html>other types</a> too which are beyond the scope of this series.</p><h3 id=ssm-managed-instances>SSM Managed Instances</h3><p>In order to have command documents executed on your instances, they will need to become <a href=https://docs.aws.amazon.com/systems-manager/latest/userguide/managed_instances.html>managed instances</a>. This requires having the below set up correctly on your instances:</p><ul><li>the <a href=https://docs.aws.amazon.com/systems-manager/latest/userguide/ssm-agent.html>SSM Agent</a> installed on your instance<ul><li>done so by default on all Amazon Linux AMIs and Windows AMIs</li></ul></li><li>connectivity from your instances to the <a href=https://docs.aws.amazon.com/general/latest/gr/ssm.html>following endpoints</a>:<ul><li><code>https://ssm.REGION.amazonaws.com</code></li><li><code>https://ssmmessages.REGION.amazonaws.com</code></li><li><code>https://ec2messages.REGION.amazonaws.com</code></li></ul></li><li>the <a href=https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-setting-up-messageAPIs.html>correct IAM permissions</a> applied on your EC2 instance profile<ul><li>these are all provided by the AWS IAM policy <a href=https://console.aws.amazon.com/iam/home#/policies/arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore$serviceLevelSummary>AmazonSSMManagedInstanceCore</a></li><li>the Terraform example for this post shows the <a href=https://github.com/jdheyburn/terraform-examples/blob/main/aws-ssm-automation-0/ec2_iam.tf>policy being attached</a> to the EC2 IAM role</li></ul></li><li><strong>Optional</strong>: <a href=https://docs.aws.amazon.com/systems-manager/latest/userguide/setup-instance-profile.html>additional policies</a> that may be required based on your use case</li></ul><figure class=center><a href=managed-instances.png><img src=managed-instances.png alt="AWS SSM Managed Instances view with two instances appearing as online and managed"></a><figcaption><p>If your instances are appearing in the <a href=https://console.aws.amazon.com/systems-manager/managed-instances>managed instances console</a> then everything is set up correctly; if not then follow the <a href=https://aws.amazon.com/premiumsupport/knowledge-center/systems-manager-ec2-instance-not-appear/>troubleshooting guide</a>.</p></figcaption></figure><h2 id=command-documents>Command documents</h2><p>Documents are defined in either JSON or, <a href=https://github.com/cblp/yaml-sucks>for better or for worse</a>, YAML. You can also define what OS each command should be executed on. This could be helpful if you wanted a healthcheck script to be executed across all (or a subset of) your instances in one action. As an example, my healthcheck script could be to check to see if the CPU is overloaded.</p><h3 id=constructing-a-healthcheck-script>Constructing a healthcheck script</h3><p>I could use the below to perform a healthcheck on a Windows box:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#8be9fd;font-style:italic>$Avg</span> = (<span style=color:#8be9fd;font-style:italic>Get-WmiObject</span> Win32_Processor | <span style=color:#8be9fd;font-style:italic>Measure-Object</span> -Property LoadPercentage -Average | <span style=color:#8be9fd;font-style:italic>Select </span>Average).Average
<span style=color:#ff79c6>If</span> (<span style=color:#8be9fd;font-style:italic>$Avg</span> <span style=color:#ff79c6>-gt</span> 90) {
  <span style=color:#ff79c6>Throw</span> <span style=color:#f1fa8c>&#34;Instance is unhealthy - Windows&#34;</span>
}
<span style=color:#8be9fd;font-style:italic>Write-Output</span> <span style=color:#f1fa8c>&#34;Instance is healthy - Windows&#34;</span>
</code></pre></div><p>And the equivalent for Linux would be:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#6272a4># Sources:</span>
<span style=color:#6272a4># https://stackoverflow.com/a/9229580</span>
<span style=color:#6272a4># https://bits.mdminhazulhaque.io/linux/round-number-in-bash-script.html</span>
<span style=color:#8be9fd;font-style:italic>avg_cpu</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>grep <span style=color:#f1fa8c>&#39;cpu &#39;</span> /proc/stat | awk <span style=color:#f1fa8c>&#39;{usage=($2+$4)*100/($2+$4+$5)} END {print int(usage)+1}&#39;</span><span style=color:#ff79c6>)</span>
<span style=color:#ff79c6>if</span> <span style=color:#ff79c6>((</span> avg_cpu &gt; <span style=color:#bd93f9>90</span> <span style=color:#ff79c6>))</span>; <span style=color:#ff79c6>then</span>
  <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;Instance is unhealthy - Linux&#34;</span>
  <span style=color:#8be9fd;font-style:italic>exit</span> <span style=color:#bd93f9>1</span>
<span style=color:#ff79c6>fi</span>
<span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;Instance is healthy - Linux&#34;</span>
</code></pre></div><blockquote><p>You&rsquo;ll notice the scripts output the OS they are running on - this will serve as an explanation for when we run the scripts as a command document later on.</p></blockquote><p>Note these scripts are just rudimentary examples of healthcheck scripts. Your healthcheck script may be checking that services are running ok, whether a task can be performed, etc. For the sake of this example, I&rsquo;ve decided to do a simple check against the CPU load for demonstration.</p><h3 id=testing-in-aws-ssm-console>Testing in AWS SSM Console</h3><p>Let&rsquo;s now test them in the AWS SSM Console. For this example I&rsquo;ve spun up two EC2 instances, one Linux and one Windows, <a href=https://github.com/jdheyburn/terraform-examples/blob/main/aws-ssm-automation-0/ec2.tf>using Terraform</a>. To run the commands we can navigate to <a href=https://console.aws.amazon.com/systems-manager/run-command/send-command>Run Command</a> in the console, and run <code>AWS-RunPowerShellScript</code> and <code>AWS-RunShellScript</code> for both Windows and Linux EC2s respectively. We don&rsquo;t care about logging the output of the scripts just yet. Make sure when running the script you manually select what instance to run it on.</p><figure class=center><a href=run-command-script-success-linux.png><img src=run-command-script-success-linux.png alt="Executing the Linux script successfully on the Linux instance"></a></figure><figure class=center><a href=run-command-script-success-windows.png><img src=run-command-script-success-windows.png alt="Executing the Windows script successfully on the Windows instance"></a></figure><p>We can see they have executed fine. Let&rsquo;s flip the condition in the healthcheck script so we can test them failing (done by changing <code>></code> to <code>&lt;</code>).</p><figure class=center><a href=run-command-script-failure-linux.png><img src=run-command-script-failure-linux.png alt="AWS indicating a failure in the command due to a failure occuring in the script"></a></figure><p>This is cool - in the script we can define what constitutes as a failure and have this propagate up to AWS - notice how the status was Failed. This will come in use later on in the series.</p><h3 id=terraforming-command-documents>Terraforming command documents</h3><p>Now let&rsquo;s get these scripts Terraformed so we can reap the <a href=https://jdheyburn.co.uk/blog/using-terraform-to-manage-aws-patch-baselines-at-enterprise-scale/#infrastructure-as-code-primer>benefits</a> of infrastructure-as-code. First we need to define the document in the YAML format.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#6272a4># documents/perform_healthcheck.yml</span>
---
<span style=color:#ff79c6>schemaVersion</span>: <span style=color:#f1fa8c>&#34;2.2&#34;</span>
<span style=color:#ff79c6>description</span>: Perform a healthcheck on the target instance
<span style=color:#ff79c6>mainSteps</span>:
  - <span style=color:#ff79c6>name</span>: PerformHealthCheckWindows
    <span style=color:#ff79c6>action</span>: aws:runPowerShellScript
    <span style=color:#ff79c6>precondition</span>:
      <span style=color:#ff79c6>StringEquals</span>:
        - platformType
        - Windows
    <span style=color:#ff79c6>inputs</span>:
      <span style=color:#ff79c6>runCommand</span>:
        - <span style=color:#f1fa8c>&#34;$Avg = (Get-WmiObject Win32_Processor | Measure-Object -Property LoadPercentage -Average | Select Average).Average&#34;</span>
        - <span style=color:#f1fa8c>&#34;If ($Avg -gt 90) {&#34;</span>
        - <span style=color:#f1fa8c>&#39;  Throw &#34;Instance is unhealthy- Linux&#34;&#39;</span>
        - <span style=color:#f1fa8c>&#34;}&#34;</span>
        - <span style=color:#f1fa8c>&#39;Write-Output &#34;Instance is healthy - Windows&#34;&#39;</span>
  - <span style=color:#ff79c6>name</span>: PerformHealthCheckLinux
    <span style=color:#ff79c6>action</span>: aws:runShellScript
    <span style=color:#ff79c6>precondition</span>:
      <span style=color:#ff79c6>StringEquals</span>:
        - platformType
        - Linux
    <span style=color:#ff79c6>inputs</span>:
      <span style=color:#ff79c6>runCommand</span>:
        - <span style=color:#f1fa8c>&#34;avg_cpu=$(grep &#39;cpu &#39; /proc/stat | awk &#39;{usage=($2+$4)*100/($2+$4+$5)} END {print int(usage)+1}&#39;)&#34;</span>
        - <span style=color:#f1fa8c>&#34;if (( avg_cpu &gt; 90 )); then&#34;</span>
        - <span style=color:#f1fa8c>&#39;  echo &#34;Instance is unhealthy - Linux&#34;&#39;</span>
        - <span style=color:#f1fa8c>&#34;  exit 1&#34;</span>
        - <span style=color:#f1fa8c>&#34;fi&#34;</span>
        - <span style=color:#f1fa8c>&#39;echo &#34;Instance is healthy - Linux&#34;&#39;</span>
</code></pre></div><blockquote><p><a href=https://github.com/jdheyburn/terraform-examples/blob/main/aws-ssm-automation-0/documents/perform_healthcheck.yml>GitHub URL</a> for the above</p></blockquote><p>Since a document is meant to perform an action (or group of actions) on a set of instances regardless of their operating system (OS), only the steps that apply to the OS platform for the instance they are being executed on will be invoked.</p><p>Therefore when we target this document to run on two types of EC2 instances, one Windows and one Linux, the step <code>PerformHealthCheckWindows</code> will be executed on the Windows box and vice versa for <code>PerformHealthCheckLinux</code>. This is because of the <code>precondition</code> key which filters on the <code>platformType</code> for the instance. Notably as well, we are targeting the appropriate actions for each platform; <code>aws:runPowerShellScript</code> for Windows and <code>aws:runShellScript</code> for Linux.</p><blockquote><p><a href=https://docs.aws.amazon.com/systems-manager/latest/userguide/ssm-plugins.html>See here</a> for a full list of what actions you can perform in a command document.</p></blockquote><p>Using Terraform you can deploy out the document to your environment like so.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#ff79c6>resource</span> <span style=color:#f1fa8c>&#34;aws_ssm_document&#34; &#34;perform_healthcheck&#34;</span> {
  name            <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;PerformHealthcheck&#34;</span>
  document_type   <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;Command&#34;</span>
  document_format <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;YAML&#34;</span>

  content <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>file</span>(<span style=color:#f1fa8c>&#34;documents/perform_healthcheck.yml&#34;</span>)
}
</code></pre></div><blockquote><p><a href=https://github.com/jdheyburn/terraform-examples/blob/main/aws-ssm-automation-0/ssm_command.tf>GitHub URL</a> for the above</p></blockquote><p>Once deployed, we can navigate to System Manager in the AWS Console to invoke the document on our estate. This is done in the same manner as when we ran <code>AWS-RunShellScript</code> above, except now we are targeting <code>PerformHealthcheck</code>. Since our document has commands for both Linux and Windows, we can have it invoked across both platform types and only the scripts written for their platform will be invoked.</p><figure class=center><a href=command-document-success.png><img src=command-document-success.png alt="Successfully executing the new command document across both Linux and Windows instances"></a></figure><p>We can see that both executed successfully! You can view the output of each command invocation on each instance like previously. For the screenshot below of the Linux instance, only the Linux step was executed, whereas the Windows step was skipped. You&rsquo;ll notice our message from earlier &ldquo;<code> - Linux</code>&rdquo; is there, reassuring us that only the Linux script was executed.</p><figure class=center><a href=command-document-success-linux.png><img src=command-document-success-linux.png alt="Focusing on the Linux invocation, highlighting that only the Linux step was invoked"></a></figure><p>Let&rsquo;s dive into some more intermediate documents.</p><h2 id=verbose-command-documents>Verbose command documents</h2><p>The example above was a very basic example of such a document where we only had a few lines of code to execute. The healthcheck script you write for your service may have several more lines of code to execute, and trying to read lines of code in amongst the document markup format is not easy on the eyes. Here is a snippet of the <strong>AWS-RunPatchBaseline</strong> document as an example of what I mean. It is written in JSON and has over 100 lines in the <code>runCommand</code> section.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  // ...
  <span style=color:#ff79c6>&#34;mainSteps&#34;</span>: [
    {
      <span style=color:#ff79c6>&#34;precondition&#34;</span>: {
        <span style=color:#ff79c6>&#34;StringEquals&#34;</span>: [<span style=color:#f1fa8c>&#34;platformType&#34;</span>, <span style=color:#f1fa8c>&#34;Windows&#34;</span>]
      },
      <span style=color:#ff79c6>&#34;action&#34;</span>: <span style=color:#f1fa8c>&#34;aws:runPowerShellScript&#34;</span>,
      <span style=color:#ff79c6>&#34;name&#34;</span>: <span style=color:#f1fa8c>&#34;PatchWindows&#34;</span>,
      <span style=color:#ff79c6>&#34;inputs&#34;</span>: {
        <span style=color:#ff79c6>&#34;timeoutSeconds&#34;</span>: <span style=color:#bd93f9>7200</span>,
        <span style=color:#ff79c6>&#34;runCommand&#34;</span>: [
          <span style=color:#f1fa8c>&#34;# Check the OS version&#34;</span>,
          <span style=color:#f1fa8c>&#34;if ([Environment]::OSVersion.Version.Major -le 5) {&#34;</span>,
          <span style=color:#f1fa8c>&#34;    Write-Error &#39;This command is not supported on Windows 2003 or lower.&#39;&#34;</span>,
          <span style=color:#f1fa8c>&#34;    exit -1&#34;</span>,
          <span style=color:#f1fa8c>&#34;} elseif ([Environment]::OSVersion.Version.Major -ge 10) {&#34;</span>,
          <span style=color:#f1fa8c>&#34;    $sku = (Get-CimInstance -ClassName Win32_OperatingSystem).OperatingSystemSKU&#34;</span>,
          <span style=color:#f1fa8c>&#34;    if ($sku -eq 143 -or $sku -eq 144) {&#34;</span>,
          <span style=color:#f1fa8c>&#34;        Write-Host &#39;This command is not supported on Windows 2016 Nano Server.&#39;&#34;</span>,
          <span style=color:#f1fa8c>&#34;        exit -1&#34;</span>,
          <span style=color:#f1fa8c>&#34;    }&#34;</span>,
          <span style=color:#f1fa8c>&#34;}&#34;</span>,
          <span style=color:#f1fa8c>&#34;# Check the SSM agent version&#34;</span>,
          <span style=color:#f1fa8c>&#34;$ssmAgentService = Get-ItemProperty &#39;HKLM:SYSTEM\\CurrentControlSet\\Services\\AmazonSSMAgent\\&#39;&#34;</span>,
          <span style=color:#f1fa8c>&#34;if (-not $ssmAgentService -or $ssmAgentService.Version -lt &#39;2.0.533.0&#39;) {&#34;</span>,
          <span style=color:#f1fa8c>&#34;    Write-Host &#39;This command is not supported with SSM Agent version less than 2.0.533.0.&#39;&#34;</span>,
          <span style=color:#f1fa8c>&#34;    exit -1&#34;</span>,
          <span style=color:#f1fa8c>&#34;}&#34;</span>,
          <span style=color:#f1fa8c>&#34;&#34;</span>
          // ...
        ]
      }
    }
  ]
}
</code></pre></div><blockquote><p>You can see the <a href=https://console.aws.amazon.com/systems-manager/documents/AWS-RunPatchBaseline/content>whole thing</a> on AWS.</p></blockquote><p>Even from this snippet it is hard to distinguish what is going on. Losing out on <a href=https://en.wikipedia.org/wiki/Syntax_highlighting>syntax highlighting</a> means the code isn&rsquo;t readable by any means. And since this is a JSON file format, we lose type hinting for the language we are writing the script in (PowerShell in this case). If the script was saved in as a PowerShell file (<code>.ps1</code>) then we&rsquo;d get all those benefits.</p><p>We can fix all these issues by adopting a common pattern when composing command documents. We can have S3 store the script, then have the command document perform these actions:</p><ol><li>Download the script in question from S3</li><li>Execute the script from the download location</li></ol><p>Such a command document would have a composition as below, whereas this is performing the same healthcheck script previously.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#6272a4># documents/perform_healthcheck_s3.yml</span>
---
<span style=color:#ff79c6>schemaVersion</span>: <span style=color:#f1fa8c>&#34;2.2&#34;</span>
<span style=color:#ff79c6>description</span>: Perform a healthcheck on the target instance
<span style=color:#ff79c6>mainSteps</span>:
  - <span style=color:#ff79c6>action</span>: aws:downloadContent
    <span style=color:#ff79c6>name</span>: DownloadScriptWindows
    <span style=color:#ff79c6>precondition</span>:
      <span style=color:#ff79c6>StringEquals</span>:
        - platformType
        - Windows
    <span style=color:#ff79c6>inputs</span>:
      <span style=color:#ff79c6>sourceType</span>: S3
      <span style=color:#ff79c6>sourceInfo</span>: <span style=color:#f1fa8c>&#39;{&#34;path&#34;:&#34;https://s3.amazonaws.com/jdheyburn-scripts/ssm_scripts/PerformHealthcheck.ps1&#34;}&#39;</span>
  - <span style=color:#ff79c6>action</span>: aws:runPowerShellScript
    <span style=color:#ff79c6>name</span>: ExecutePerformHealthCheckWindows
    <span style=color:#ff79c6>precondition</span>:
      <span style=color:#ff79c6>StringEquals</span>:
        - platformType
        - Windows
    <span style=color:#ff79c6>inputs</span>:
      <span style=color:#ff79c6>runCommand</span>:
        - ..\downloads\PerformHealthcheck.ps1
  - <span style=color:#ff79c6>action</span>: aws:downloadContent
    <span style=color:#ff79c6>name</span>: DownloadScriptLinux
    <span style=color:#ff79c6>precondition</span>:
      <span style=color:#ff79c6>StringEquals</span>:
        - platformType
        - Linux
    <span style=color:#ff79c6>inputs</span>:
      <span style=color:#ff79c6>sourceType</span>: S3
      <span style=color:#ff79c6>sourceInfo</span>: <span style=color:#f1fa8c>&#39;{&#34;path&#34;:&#34;https://s3.amazonaws.com/jdheyburn-scripts/ssm_scripts/perform_healthcheck.sh&#34;}&#39;</span>
  - <span style=color:#ff79c6>action</span>: aws:runShellScript
    <span style=color:#ff79c6>name</span>: ExecutePerformHealthCheckLinux
    <span style=color:#ff79c6>precondition</span>:
      <span style=color:#ff79c6>StringEquals</span>:
        - platformType
        - Linux
    <span style=color:#ff79c6>inputs</span>:
      <span style=color:#ff79c6>runCommand</span>:
        - ../downloads/perform_healthcheck.sh
</code></pre></div><blockquote><p><a href=https://github.com/jdheyburn/terraform-examples/blob/main/aws-ssm-automation-0/documents/perform_healthcheck_s3.yml>GitHub URL</a> for the above</p></blockquote><p>Note the new action called <code>aws:downloadContent</code> - which you can view the documentation for <a href=https://docs.aws.amazon.com/systems-manager/latest/userguide/ssm-plugins.html#aws-downloadContent>here</a>. Again we&rsquo;re using the <code>precondition</code> key to ensure each platforms downloads their respective script. We&rsquo;re also using the <code>inputs</code> key to instruct the action where it can download the script from; S3 in this case, at the given S3 bucket location. There is an optional <code>destinationPath</code> field which allows you to change where it downloads to.</p><p>Once the script is downloaded to the instance, we will need to have it executed. <code>aws:downloadContent</code> saves the script to a temporary directory for executing SSM command invocations on instances, so we need to reference it in the <code>downloads</code> directory for it; indicated by the <code>../downloads/perform_healthcheck.sh</code> command.</p><h3 id=terraforming-verbose-command-documents>Terraforming verbose command documents</h3><p>This involves having your script first uploaded to S3. Thankfully, through the power of <a href=https://jdheyburn.co.uk/blog/using-terraform-to-manage-aws-patch-baselines-at-enterprise-scale/#infrastructure-as-code-primer>infrastructure-as-code</a>, you can have this automatically deployed to your environment once the module is written.</p><p>Check the <a href=https://github.com/jdheyburn/terraform-examples/blob/main/aws-ssm-automation-0/ssm_command_s3.tf>GitHub repository</a> for the full example, for now let me break down what each bit is doing.</p><h4 id=kms>KMS</h4><p>I want my S3 bucket to encrypt objects that are stored there, so we&rsquo;ll need to create a <a href=https://aws.amazon.com/kms/>KMS key</a> and give it an IAM policy permitting any users of the account to decrypt using the key. You can make this more secure by only targeting the IAM roles that require it, instead of the whole account, adopting the <a href=https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege>principle of least privilege</a> best practice ðŸ”’</p><blockquote><p>You can read up more about IAM policies <a href=https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies.html>here</a>.</p></blockquote><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#ff79c6>data</span> <span style=color:#f1fa8c>&#34;aws_iam_policy_document&#34; &#34;kms_allow_decrypt&#34;</span> {
  <span style=color:#ff79c6>statement</span> {
    sid    <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;AllowKMSAdministration&#34;</span>
    effect <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;Allow&#34;</span>

    actions <span style=color:#ff79c6>=</span> [
      <span style=color:#f1fa8c>&#34;kms:Create*&#34;</span>,
      <span style=color:#f1fa8c>&#34;kms:Describe*&#34;</span>,
      <span style=color:#f1fa8c>&#34;kms:Enable*&#34;</span>,
      <span style=color:#f1fa8c>&#34;kms:List*&#34;</span>,
      <span style=color:#f1fa8c>&#34;kms:Put*&#34;</span>,
      <span style=color:#f1fa8c>&#34;kms:Update*&#34;</span>,
      <span style=color:#f1fa8c>&#34;kms:Revoke*&#34;</span>,
      <span style=color:#f1fa8c>&#34;kms:Disable*&#34;</span>,
      <span style=color:#f1fa8c>&#34;kms:Get*&#34;</span>,
      <span style=color:#f1fa8c>&#34;kms:Delete*&#34;</span>,
      <span style=color:#f1fa8c>&#34;kms:ScheduleKeyDeletion&#34;</span>,
      <span style=color:#f1fa8c>&#34;kms:CancelKeyDeletion&#34;</span>
    ]

    <span style=color:#ff79c6>principals</span> {
      type        <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;AWS&#34;</span>
      identifiers <span style=color:#ff79c6>=</span> [<span style=color:#f1fa8c>&#34;arn:aws:iam::${data.aws_caller_identity.current.account_id}:user/jdheyburn&#34;</span>]
    }

    resources <span style=color:#ff79c6>=</span> [<span style=color:#f1fa8c>&#34;*&#34;</span>]
  }

  <span style=color:#ff79c6>statement</span> {
    sid    <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;AllowDecrypt&#34;</span>
    effect <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;Allow&#34;</span>

    actions <span style=color:#ff79c6>=</span> [<span style=color:#f1fa8c>&#34;kms:Decrypt&#34;</span>]

    <span style=color:#ff79c6>principals</span> {
      type        <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;AWS&#34;</span>
      identifiers <span style=color:#ff79c6>=</span> [<span style=color:#f1fa8c>&#34;arn:aws:iam::${data.aws_caller_identity.current.account_id}:root&#34;</span>]<span style=color:#6272a4>
</span><span style=color:#6272a4>      # TIP: For increased security only give decrypt permissions to roles that need it
</span><span style=color:#6272a4>      # identifiers = [aws_iam_role.vm_base.arn]
</span><span style=color:#6272a4></span>    }

    resources <span style=color:#ff79c6>=</span> [<span style=color:#f1fa8c>&#34;*&#34;</span>]
  }
}

<span style=color:#ff79c6>resource</span> <span style=color:#f1fa8c>&#34;aws_kms_key&#34; &#34;script_bucket_key&#34;</span> {
  description <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;This key is used to encrypt bucket objects&#34;</span>
  policy      <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>data</span>.<span style=color:#ff79c6>aws_iam_policy_document</span>.<span style=color:#ff79c6>kms_allow_decrypt</span>.<span style=color:#ff79c6>json</span>
}
</code></pre></div><h4 id=s3>S3</h4><p>Next we&rsquo;re creating the S3 bucket to store the scripts; we&rsquo;re encrypting it with the KMS key we created, <code>aws_kms_key.script_bucket_key</code>. We&rsquo;re also applying an IAM policy on the bucket permitting any users of the account to download anything from the <code>ssm_scripts/</code> prefix in the bucket (this prefix is where the scripts will be stored).</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#ff79c6>resource</span> <span style=color:#f1fa8c>&#34;aws_s3_bucket&#34; &#34;script_bucket&#34;</span> {
  bucket <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;jdheyburn-scripts&#34;</span><span style=color:#6272a4>
</span><span style=color:#6272a4>
</span><span style=color:#6272a4>  # Encrypt objects stored in S3
</span><span style=color:#6272a4></span>  <span style=color:#ff79c6>server_side_encryption_configuration</span> {
    <span style=color:#ff79c6>rule</span> {
      <span style=color:#ff79c6>apply_server_side_encryption_by_default</span> {
        kms_master_key_id <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>aws_kms_key</span>.<span style=color:#ff79c6>script_bucket_key</span>.<span style=color:#ff79c6>arn</span>
        sse_algorithm     <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;aws:kms&#34;</span>
      }
    }
  }
}

<span style=color:#ff79c6>data</span> <span style=color:#f1fa8c>&#34;aws_caller_identity&#34; &#34;current&#34;</span> {}

<span style=color:#ff79c6>data</span> <span style=color:#f1fa8c>&#34;aws_iam_policy_document&#34; &#34;s3_allow_script_download&#34;</span> {
  <span style=color:#ff79c6>statement</span> {
    sid    <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;AllowAccountAccess&#34;</span>
    effect <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;Allow&#34;</span>

    actions <span style=color:#ff79c6>=</span> [<span style=color:#f1fa8c>&#34;s3:GetObject&#34;</span>]

    <span style=color:#ff79c6>principals</span> {
      type        <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;AWS&#34;</span>
      identifiers <span style=color:#ff79c6>=</span> [<span style=color:#f1fa8c>&#34;arn:aws:iam::${data.aws_caller_identity.current.account_id}:root&#34;</span>]<span style=color:#6272a4>
</span><span style=color:#6272a4>      # TIP: For increased security only give decrypt permissions to roles that need it
</span><span style=color:#6272a4>      # identifiers = [aws_iam_role.vm_base.arn]
</span><span style=color:#6272a4></span>    }

    resources <span style=color:#ff79c6>=</span> [<span style=color:#f1fa8c>&#34;${aws_s3_bucket.script_bucket.arn}/ssm_scripts/*&#34;</span>]
  }
}

<span style=color:#ff79c6>resource</span> <span style=color:#f1fa8c>&#34;aws_s3_bucket_policy&#34; &#34;script_bucket_policy&#34;</span> {
  bucket <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>aws_s3_bucket</span>.<span style=color:#ff79c6>script_bucket</span>.<span style=color:#ff79c6>id</span>
  policy <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>data</span>.<span style=color:#ff79c6>aws_iam_policy_document</span>.<span style=color:#ff79c6>s3_allow_script_download</span>.<span style=color:#ff79c6>json</span>
}
</code></pre></div><h4 id=store-scripts-in-s3>Store Scripts in S3</h4><p>Now we are uploading the scripts from their <a href=https://github.com/jdheyburn/terraform-examples/tree/main/aws-ssm-automation-0/scripts>location in the repository</a> to S3, at the prefix where we defined an IAM policy to pull them from.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#ff79c6>locals</span> {
  perform_healthcheck_script_fname_windows <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;PerformHealthcheck.ps1&#34;</span>
  perform_healthcheck_script_fname_linux   <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;perform_healthcheck.sh&#34;</span>
}

<span style=color:#ff79c6>resource</span> <span style=color:#f1fa8c>&#34;aws_s3_bucket_object&#34; &#34;perform_healthcheck_windows&#34;</span> {
  bucket  <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>aws_s3_bucket</span>.<span style=color:#ff79c6>script_bucket</span>.<span style=color:#ff79c6>id</span>
  key     <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;ssm_scripts/${local.perform_healthcheck_script_fname_windows}&#34;</span>
  content <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>file</span>(<span style=color:#f1fa8c>&#34;scripts/${local.perform_healthcheck_script_fname_windows}&#34;</span>)
}

<span style=color:#ff79c6>resource</span> <span style=color:#f1fa8c>&#34;aws_s3_bucket_object&#34; &#34;perform_healthcheck_linux&#34;</span> {
  bucket  <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>aws_s3_bucket</span>.<span style=color:#ff79c6>script_bucket</span>.<span style=color:#ff79c6>id</span>
  key     <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;ssm_scripts/${local.perform_healthcheck_script_fname_linux}&#34;</span>
  content <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>file</span>(<span style=color:#f1fa8c>&#34;scripts/${local.perform_healthcheck_script_fname_linux}&#34;</span>)
}
</code></pre></div><h4 id=ssm-document>SSM Document</h4><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#ff79c6>resource</span> <span style=color:#f1fa8c>&#34;aws_ssm_document&#34; &#34;perform_healthcheck_s3&#34;</span> {
  name            <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;PerformHealthcheckS3&#34;</span>
  document_type   <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;Command&#34;</span>
  document_format <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;YAML&#34;</span>

  content <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>templatefile</span>(
    <span style=color:#f1fa8c>&#34;documents/perform_healthcheck_s3_template.yml&#34;</span>,
    {
      bucket_name   <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>aws_s3_bucket</span>.<span style=color:#ff79c6>script_bucket</span>.<span style=color:#ff79c6>id</span>,
      linux_fname   <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>local</span>.<span style=color:#ff79c6>perform_healthcheck_script_fname_linux</span>,
      linux_key     <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>aws_s3_bucket_object</span>.<span style=color:#ff79c6>perform_healthcheck_linux</span>.<span style=color:#ff79c6>id</span>,
      windows_fname <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>local</span>.<span style=color:#ff79c6>perform_healthcheck_script_fname_windows</span>,
      windows_key   <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>aws_s3_bucket_object</span>.<span style=color:#ff79c6>perform_healthcheck_windows</span>.<span style=color:#ff79c6>id</span>,
    }
  )
}
</code></pre></div><p>Here we&rsquo;re creating an <code>aws_ssm_document</code> as we had done <a href=#terraforming-command-documents>before</a>, but the document file we&rsquo;re targeting this time is a template file.</p><p>Notice how we have the presence of <code>${bucket_name}</code> and others? These are template variables. With the use of the <a href=https://www.terraform.io/docs/configuration/functions/templatefile.html>Terraform function</a> <code>templatefile()</code>, we can insert Terraform variables into the config to have the template name replaced with the value we&rsquo;re passing in. In this case, <code>${bucket_name}</code> will get replaced with the output of <code>aws_s3_bucket.script_bucket.id</code>, which is <code>jdheyburn-scripts</code>, and the same for the remaining variables.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#6272a4># documents/perform_healthcheck_s3_template.yml</span>
---
<span style=color:#ff79c6>schemaVersion</span>: <span style=color:#f1fa8c>&#34;2.2&#34;</span>
<span style=color:#ff79c6>description</span>: Perform a healthcheck on the target instance
<span style=color:#ff79c6>mainSteps</span>:
  - <span style=color:#ff79c6>action</span>: aws:downloadContent
    <span style=color:#ff79c6>name</span>: DownloadScriptWindows
    <span style=color:#ff79c6>precondition</span>:
      <span style=color:#ff79c6>StringEquals</span>:
        - platformType
        - Windows
    <span style=color:#ff79c6>inputs</span>:
      <span style=color:#ff79c6>sourceType</span>: S3
      <span style=color:#ff79c6>sourceInfo</span>: <span style=color:#f1fa8c>&#39;{&#34;path&#34;:&#34;https://s3.amazonaws.com/${bucket_name}/${windows_key}&#34;}&#39;</span>
  - <span style=color:#ff79c6>action</span>: aws:runPowerShellScript
    <span style=color:#ff79c6>name</span>: ExecutePerformHealthCheckWindows
    <span style=color:#ff79c6>precondition</span>:
      <span style=color:#ff79c6>StringEquals</span>:
        - platformType
        - Windows
    <span style=color:#ff79c6>inputs</span>:
      <span style=color:#ff79c6>runCommand</span>:
        - ..\downloads\${windows_fname}
  - <span style=color:#ff79c6>action</span>: aws:downloadContent
    <span style=color:#ff79c6>name</span>: DownloadScriptLinux
    <span style=color:#ff79c6>precondition</span>:
      <span style=color:#ff79c6>StringEquals</span>:
        - platformType
        - Linux
    <span style=color:#ff79c6>inputs</span>:
      <span style=color:#ff79c6>sourceType</span>: S3
      <span style=color:#ff79c6>sourceInfo</span>: <span style=color:#f1fa8c>&#39;{&#34;path&#34;:&#34;https://s3.amazonaws.com/${bucket_name}/${linux_key}&#34;}&#39;</span>
  - <span style=color:#ff79c6>action</span>: aws:runShellScript
    <span style=color:#ff79c6>name</span>: ExecutePerformHealthCheckLinux
    <span style=color:#ff79c6>precondition</span>:
      <span style=color:#ff79c6>StringEquals</span>:
        - platformType
        - Linux
    <span style=color:#ff79c6>inputs</span>:
      <span style=color:#ff79c6>runCommand</span>:
        - ../downloads/${linux_fname}
</code></pre></div><blockquote><p><a href=https://github.com/jdheyburn/terraform-examples/blob/main/aws-ssm-automation-0/documents/perform_healthcheck_s3_template.yml>GitHub URL</a> for the above</p></blockquote><h4 id=ec2-iam-permissions>EC2 IAM Permissions</h4><p>For the pattern to work, you&rsquo;ll need to attach an IAM policy to the instance to allow it to pull the scripts from the S3 bucket. If we don&rsquo;t do this then the <code>aws:downloadContent</code> action will fail. From the Terraform above we&rsquo;ve already applied the corresponding permissions on the S3 bucket, allowing all users and roles in the account to perform <code>s3:GetObject</code> on the scripts. We&rsquo;ve also allowed done the same for performing <code>kms:Decrypt</code> on the KMS key that encrypts the S3 objects.</p><p>If you&rsquo;ve been following the <a href=https://github.com/jdheyburn/terraform-examples/blob/main/aws-ssm-automation-0/ec2_iam.tf#L33>GitHub example</a>, these required permissions have already been defined - for a recap:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#ff79c6>data</span> <span style=color:#f1fa8c>&#34;aws_iam_policy_document&#34; &#34;ssm_scripts&#34;</span> {
  <span style=color:#ff79c6>statement</span> {
    sid    <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;AllowS3&#34;</span>
    effect <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;Allow&#34;</span>

    actions <span style=color:#ff79c6>=</span> [<span style=color:#f1fa8c>&#34;s3:GetObject&#34;</span>]

    resources <span style=color:#ff79c6>=</span> [
      <span style=color:#f1fa8c>&#34;${aws_s3_bucket.script_bucket.arn}/ssm_scripts/*&#34;</span>,
    ]
  }

  <span style=color:#ff79c6>statement</span> {
    sid    <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;AllowKMS&#34;</span>
    effect <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;Allow&#34;</span>

    actions <span style=color:#ff79c6>=</span> [<span style=color:#f1fa8c>&#34;kms:Decrypt&#34;</span>]

    resources <span style=color:#ff79c6>=</span> [<span style=color:#ff79c6>aws_kms_key</span>.<span style=color:#ff79c6>script_bucket_key</span>.<span style=color:#ff79c6>arn</span>]
  }
}

<span style=color:#ff79c6>resource</span> <span style=color:#f1fa8c>&#34;aws_iam_policy&#34; &#34;ssm_scripts&#34;</span> {
  name        <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;PullSSMScripts&#34;</span>
  description <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;Enables instances to download SSM scripts from S3&#34;</span>

  policy <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>data</span>.<span style=color:#ff79c6>aws_iam_policy_document</span>.<span style=color:#ff79c6>ssm_scripts</span>.<span style=color:#ff79c6>json</span>
}

<span style=color:#ff79c6>resource</span> <span style=color:#f1fa8c>&#34;aws_iam_role_policy_attachment&#34; &#34;instance_download_scripts&#34;</span> {<span style=color:#6272a4>
</span><span style=color:#6272a4>  # Change this to point to the role(s) for your instances
</span><span style=color:#6272a4></span>  role       <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>aws_iam_role</span>.<span style=color:#ff79c6>vm_base</span>.<span style=color:#ff79c6>name</span>
  policy_arn <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>aws_iam_policy</span>.<span style=color:#ff79c6>ssm_scripts</span>.<span style=color:#ff79c6>arn</span>
}
</code></pre></div><p>This is an important concept to remember about setting IAM policies - you will need to ensure that the correct permissions are applied on both the <em>source</em> of the requestor, as well as the <em>destination</em>.</p><h3 id=testing-verbose-documents>Testing verbose documents</h3><p>Now, let&rsquo;s give this command a spin in the console. We&rsquo;re going to execute it the same way we did for other documents earlier, except now targeting <code>PerformHealthcheckS3</code>.</p><figure class=center><a href=s3-command-document-success.png><img src=s3-command-document-success.png alt="Successful invocations for the new document pulling the script to be executed from S3"></a></figure><p>If you got any failures, make sure to dive into the failed invocation and see why it failed. Did it fail because of your healthcheck command? Then it is working as intended! Although if it failed on <code>aws:downloadContent</code>, check to make sure your instances are running the latest version of SSM agent. You can do this with the <code>AWS-UpdateSSMAgent</code> SSM document. Don&rsquo;t be like me and spend hours troubleshooting against an out-of-date SSM agent! ðŸ˜‚</p><blockquote class=twitter-tweet><p lang=en dir=ltr>Trying to write my next blog post about AWS SSM, and had a load of hours wiped out trying to troubleshoot an issue with SSM agents... turns out AWS AMIs install these bad agent versions by default ðŸ˜­<a href=https://t.co/mgFMVyB5fL>https://t.co/mgFMVyB5fL</a></p>&mdash; Joseph D. Heyburn (@jdheyburn) <a href="https://twitter.com/jdheyburn/status/1320011701480284162?ref_src=twsrc%5Etfw">October 24, 2020</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><p>Let&rsquo;s now dive into the output of the Linux instance.</p><figure class=center><a href=s3-command-document-success-linux.png><img src=s3-command-document-success-linux.png alt="Breakdown of steps invoked on Linux for a the command document we executed earlier, Windows steps are skipped"></a></figure><p>Just like with the previous document with the script embedded <code>PerformHealthcheck</code>, we can see the steps conditioned for Windows have been skipped (steps 1-2). Step 3 is where the document is doing real work, downloading the Linux script from the S3 location into the temp directory for SSM, and then executing it in step 4.</p><h2 id=conclusion>Conclusion</h2><p>I think this has been my longest post thus far, and it&rsquo;s only part one of this series. SSM is a bit of a beast and is often shrugged off as being a pain to set up and troubleshoot. I put that down to it encapsulating several other services, and a lack of tried and tested documented methods - which I hope this series resolves.</p><p>We covered in this post:</p><ul><li>What SSM Documents are; and the differences between Command and Automation documents</li><li>How to create our own command documents to execute the same business logic on differing instance platforms</li><li>Adopting best practices by storing scripts in S3 and have a command document orchestrate the download and execution of said scripts</li><li>&mldr; all while written in Terraform!</li></ul><p>If any mistakes were made in this post then please <a href=#contact>contact</a> me - thanks for reading! ðŸ˜ƒ</p></div><footer><section class=see-also></section></footer></article></section></div><footer class=footer><section class=container>Â©
2020
Joseph D. Heyburn
Â·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main></body></html>